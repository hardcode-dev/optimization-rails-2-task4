# Задание №4

## Подготовка

Согласно заданию, я настроил локальный мониторинг с помощью NewRelic, SkyLight (который уже используется в проекте) и
подключил DIY (если можно так назвать сборку нескольких готовых решений в кучу) мониторинг с помощью связки Prometheus + Grafana.
Для этого понадобилось установить Графану на свою машину, настроить ее, добавить запуск Прометеуса в Procfile и немного настроить его.
Выгрузку метрик и дашборд в Графане сделал с помощью гема yabeda-rails, который внутри использует prometheus-exporter
и плагина для Графаны Yabeda Rails. Так же установил в проект rack-mini-profiler и rails panel для Хрома.

## local_production

Для начала надо определиться, какой выбрать путь — сделать отдельный энв, либо использовать production, но переопределить
его настройки для локального запуска. Посмотрим, много ли в коде завязок на production енв.

```
$ grep -IR 'Rails\.env\.production?' ./*/** | wc -l
31
```

Вхождений много, но если посмотреть на контекст использования в большинстве случаев, то становится понятно, что для наших целей
(профилирования приложения) лучше будет все таки сделать отдельный энв.
`$ grep -c=5 -IR 'Rails\.env\.production?' ./*/**`

Исключим новое окружение в настройках Airbrake:
`c.ignore_environments = %w[test development local_production]`

Добавим новое окружение в `newrelic.yml`, `webpacker.yml` и `secrets.yml`. Настройки опишем в новом файле
`config/environments/local_production.rb`. Чтобы запускать новый энв заведем `Procfile.local_prod` и `bin/local_prod_startup`
по аналогии с другими вариантами запуска.

## Оптимизация

Оптимизируем рендеринг главной страницы. Она не самая медленная, но наиболее востребованная, поэтому ее оптимизация даст
большой выйгрышь в производительности. Для начала замерим время ответов на нашем новом окружении с помощью `ab`.

```
$ ab -n 100 http://127.0.0.1:3000/
...
Time taken for tests:   15.013 seconds
...
Percentage of the requests served within a certain time (ms)
50%    127
66%    160
75%    174
80%    189
90%    236
95%    320
98%    388
99%    466
100%    466 (longest request)
```

При рендери страницы больше всего времни занимает рендер паршиала `articles/single_story`. Включим локальный кеш согласно конфигу:

```
touch tmp/caching-dev.txt
```

Закешируем story:

```
<% cache story do %>
  <%= render "articles/single_story", story: story %>
<% end %>
```

И попробуем наш тест с `ab` еще раз:

```
$ ab -n 100 http://127.0.0.1:3000/
...
Time taken for tests:   4.599 seconds
...
Percentage of the requests served within a certain time (ms)
50%     33
66%     39
75%     43
80%     47
90%     59
95%     73
98%     94
99%    878
100%    878 (longest request)
```

По статистике видно, что время ответа стало дольше для тех случаев, когда story встречается первый раз, но среднее время
ответа сократилось в 3 раза. А если продолжить тест на уже запущенный сервер, где нет новых сторей, то время на 100 ответов
будет болтаться аж в районе 3.5 секунд, что примерно в 4.2 раза быстрее первоначального результата.
