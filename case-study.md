# Задание 4

Для того, чтобы найти "точки роста" для оптимизации я воспользовался:

- rack-mini-profiler
- rails panel
- new_relic
- skylight

## Оптимизация

Все инструменты мониторинга показывают, что самой горячей точкой является главная страница, `StoriesController#index`.
В частности, заметное время занимает рендеринг `partial`-ов `_single_story.html.erb`.
В качестве метрики выбрал среднее время запроса через бенчмарк ab (30 запросов):

```
Time per request:       486.978 [ms] (mean)

Percentage of the requests served within a certain time (ms)
  50%    478
  66%    503
  75%    514
  80%    544
  90%    622
  95%    739
  98%    756
  99%    756
 100%    756 (longest request)
```

### Находка №1

- Рендеринг паршала \_single_story.html.erb занимаает много времени
- Кэширую story перед передачей в паршал. Touch: true добавлять не стал, так как гем counter_culture вроде сам обновляет поля
  счетчиков в таблице articles, значит вместе с ними обновляется и updated_at. Проверил обновление счетчика на главной после создания комментария -
  счетчик обновляется корректно после рефреша страницы в браузере, но при SPA-переходе со страницы статьи на главную страницу почему то счетчик не меняется
  (возможно что-то еще надо подправить в js)
- В RackMiniProfiler количество рендеров сильно уменьшилось
- Метрика бэнчмарка улучшилась значительно:

```
Time per request:       246.296 [ms] (mean)

Percentage of the requests served within a certain time (ms)
  50%    236
  66%    251
  75%    264
  80%    297
  90%    343
  95%    348
  98%    375
  99%    375
 100%    375 (longest request)
```

### Результаты

В результате проделанной работы удалось значительно уменьшить время загрузки заглавной страницы.
В дальнейших поисках точек роста также пытался закэшировать `@featured_story` в app/views/articles/index.html.erb
но результата это не принесло :(

Познакомился и установил инструменты мониторинга new_relic и skylight.
Также узнал про инструменты нагрузочного тестирования apache benchmark и siege.
