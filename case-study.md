# Задание 4

## Подготовка

### Настройка проекта для локального запуска

[x] Регистрация и получение токена algola
[x] Установка foreman (gem install 'foreman')

### Настрока мониторинга (выбран new-relic)

[x] Регистрация и получения ключа
[x] Добавление конфигурационного файла в проект и в gitignore

### Настройка локального продакшн окружения

[x] Создан файл Procfile.lp
[x] Создан конфигурационый файл для этого окружения в config/environment. Выбрал создание отельного файла с конфигурацие окружения, т.к. считаю что по хорошему общие места должны быть вынесены в третье место и переиспользованы между окружениями, но конфигов здесь и так тьма. Заводить еще один не хочется. Также не очень хочется решать что-то if/else в конфигах без явной необходимости, для меня это очень затрудняет их чтение.

## Оптимизация

Все инструменты мониторинга показывают, что самой горячей точкой является главная страница, `StoriesController#index`.

В частности, заметное время занимает рендеринг `partial`-ов `_single_story.html.erb`.

До оптимизации

```
Percentage of the requests served within a certain time (ms)
  50%    460
  66%    466
  75%    485
  80%    559
  90%    630
  95%    630
  98%    630
  99%    630
 100%    630 (longest request)
```

### Находка №1

- Рендеринг паршала занимааает заметное время
- Передаю в паршал коллекцию, вместо цикла.
- В RackMiniProfiler количество рендеров сильно уменьшилось
- Метрика улучшилась незначительно

```
Percentage of the requests served within a certain time (ms)
  50%    407
  66%    409
  75%    415
  80%    419
  90%    551
  95%    551
  98%    551
  99%    551
 100%    551 (longest request)
```

### Находка №2

- Обнаружил, что Procfile.lp загружает окружение в development :see_no_evil:
- Изменил Procfile.lp, чтобы он таки загружал local_production
- Откатил изменеия, чтобы посмотреть на изначальную метрику.

```
Percentage of the requests served within a certain time (ms)
 50%     79
 66%    125
 75%    708
 80%    727
 90%    971
 95%    971
 98%    971
 99%    971
100%    971 (longest request)
```

### Находка №3

- Rack mini profiler показывает, что наибольшее время занимает рендер паршала single_stroy.
- Добавил кеширование при рендере по коллекции историй, а также по индикатору залогинен пользователь или нет (чтобы не показывать приглашения для регистрации). Также добавил `touch: true` к связям комментариев и реакций с историями, дял сброса кеши при каком либо обновлении.
- В RackMiniProfiler больше нет информации о рендерк `single_story`.

```
Percentage of the requests served within a certain time (ms)
  50%     44
  66%     47
  75%     59
  80%     70
  90%     86
  95%     86
  98%     86
  99%     86
 100%     86 (longest request)
```

### Результаты

В результате проделанной работы удалось значительно уменьить время загрузки страницы. Познакомился поближе с new_relic (на работе Datadog), и как его подключать.
Также узнал и воспользовался инструментом apache benchmark. Достаточно полезный инструмент для замера времени ответов эндпоинтов.

Подход с созданием local_production окружением понравился. Думаю применю его на работе.
